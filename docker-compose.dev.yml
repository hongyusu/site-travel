# Development Docker Compose Configuration
# Full development setup with backend and frontend in Docker
# 
# Prerequisites:
#   1. Start database services: docker compose -f docker-compose.services.yml up -d
#   2. Start dev services: docker compose -f docker-compose.dev.yml up -d
#
# Access:
#   Frontend: http://localhost:3000
#   Backend: http://localhost:8000 (containerized)
#   Database: localhost:5432 (from services)
#   Redis: localhost:6379 (from services)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      args:
        - PYTHON_VERSION=3.12
    container_name: findtravelmate_backend_dev
    restart: "no"  # Don't auto-restart in development
    environment:
      # Database connection - connect to external containers
      DATABASE_URL: postgresql://postgres:password@host.docker.internal:5432/findtravelmate
      DB_POOL_SIZE: 10
      DB_MAX_OVERFLOW: 5
      DB_POOL_TIMEOUT: 30
      
      # Development settings
      PYTHON_ENV: development
      LOG_LEVEL: DEBUG
      AUTO_INIT_DB: false  # Database already initialized
      
      # Redis connection - connect to external container
      REDIS_URL: redis://host.docker.internal:6379/0
      
      # Application
      APP_NAME: FindTravelMate
      
      # Optional features for development
      ENABLE_REGISTRATION: true
      ENABLE_VENDOR_SIGNUP: true
      ENABLE_REVIEWS: true
      ENABLE_WISHLIST: true
    volumes:
      - ./backend:/app  # Mount source code for hot reload
      - backend_logs:/app/logs
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Enable access to host services
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/activities/categories"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - dev-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development  # Use development stage from Dockerfile
      args:
        - NODE_VERSION=20
        - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
    container_name: findtravelmate_frontend_dev
    restart: "no"  # Don't auto-restart in development
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000/api/v1  # Browser connects to host
      NODE_ENV: development
    user: "0:0"  # Run as root to avoid permission issues in development
    volumes:
      - ./frontend:/app  # Mount source code for hot reload
      - /app/node_modules  # Preserve node_modules in container
      - frontend_next_cache:/app/.next  # Use named volume for .next cache
    ports:
      - "3000:3000"  # Map to port 3000
    depends_on:
      - backend  # Ensure backend starts first
    command: npm run dev
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow container to access host services
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - dev-network

volumes:
  frontend_next_cache:
    driver: local
  backend_logs:
    driver: local

networks:
  dev-network:
    driver: bridge